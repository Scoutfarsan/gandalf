#!/usr/bin/env bash
# Robust toggle utan pipelines (undviker "pipe error: Too many open files")
set -euo pipefail

should_skip_today(){
  # Return 0 = SKIP (ingen blockall), 1 = OK att köra
  local mmdd dow dd mm
  mmdd="$(date +%m-%d)"
  dow="$(date +%u)"   # 1=Mon .. 5=Fri .. 7=Sun
  dd="$(date +%d)"
  mm="$(date +%m)"

  # Fasta undantag
  case "$mmdd" in
    01-01|12-23|12-24|12-31) return 0 ;;
  esac

  # Midsommarafton: fredag mellan 19–25 juni
  if [[ "$mm" == "06" && "$dow" == "5" ]]; then
    if (( 10#$dd >= 19 && 10#$dd <= 25 )); then
      return 0
    fi
  fi

  return 1
}


if should_skip_today; then
  say "SKIP: holiday exception (no blockall today)"
  exit 0
fi

ulimit -n 8192 >/dev/null 2>&1 || true

ACTION="${1:-}"; shift || true

if [[ "" == "check" ]]; then
  if should_skip_today; then
    echo "SKIP"
  else
    echo "RUN"
  fi
  exit 0
fi

DB="/etc/pihole/gravity.db"
ID_FILE="/var/lib/gandalf/pihole_blockall_domainlist_id"
LOG="/var/log/pihole-blockall-toggle.log"
STOP_FTL="${STOP_FTL:-1}"

ts(){ date '+%F %T'; }
say(){ local m; m="$(ts) [blockall] $*"; echo "$m" >>"$LOG"; echo "$m"; }

need(){ command -v "$1" >/dev/null 2>&1 || { say "ERROR: Missing $1"; exit 2; }; }
need sqlite3
need systemctl
need pihole

sql(){
  sqlite3 -cmd ".timeout 8000" "$DB" "$1"
}

gid(){
  sql "SELECT id FROM 'group' WHERE name='$1' LIMIT 1;"
}

if [[ ! -f "$ID_FILE" ]]; then
  say "ERROR: Missing $ID_FILE (run pihole-policy-apply once)"
  exit 2
fi
BLOCKALL_ID="$(cat "$ID_FILE")"

if [[ "$ACTION" != "on" && "$ACTION" != "off" ]]; then
  say "Usage: $0 on|off Group1 Group2 ..."
  exit 2
fi

FTL_WAS_ACTIVE=0
cleanup(){
  if (( STOP_FTL == 1 )) && (( FTL_WAS_ACTIVE == 1 )); then
    say "Starting pihole-FTL (restore)"
    systemctl start pihole-FTL >/dev/null 2>&1 || true
  fi
}
trap cleanup EXIT

if (( STOP_FTL == 1 )); then
  if systemctl is-active --quiet pihole-FTL 2>/dev/null; then
    FTL_WAS_ACTIVE=1
    say "Stopping pihole-FTL to avoid sqlite lock"
    systemctl stop pihole-FTL >/dev/null 2>&1 || true
  fi
fi

for g in "$@"; do
  GID="$(gid "$g")"
  if [[ -z "${GID:-}" ]]; then
    say "SKIP: group not found: $g"
    continue
  fi

  if [[ "$ACTION" == "on" ]]; then
    say "ON: $g"
    sql "INSERT OR IGNORE INTO domainlist_by_group(domainlist_id,group_id) VALUES($BLOCKALL_ID,$GID);"
  else
    say "OFF: $g"
    sql "DELETE FROM domainlist_by_group WHERE domainlist_id=$BLOCKALL_ID AND group_id=$GID;"
  fi
done

# Starta FTL innan reloaddns (bra hygiene)
if (( STOP_FTL == 1 )) && (( FTL_WAS_ACTIVE == 1 )); then
  say "Starting pihole-FTL before reloaddns"
  systemctl start pihole-FTL >/dev/null 2>&1 || true
  FTL_WAS_ACTIVE=0
fi

pihole reloaddns >/dev/null 2>&1 || true
say "DONE"
