#!/usr/bin/env bash

pihole_reload_dns(){
  # Pi-hole CLI skiljer mellan versioner: vissa har restartdns, andra har reloaddns.
  if pihole help 2>/dev/null | grep -qE '(^|[[:space:]])restartdns([[:space:]]|$)'; then
pihole_reload_dns >>"$LOG" 2>&1 || true
  else
pihole_reload_dns >>"$LOG" 2>&1 || true
  fi
}
#!/usr/bin/env bash
set -euo pipefail

ACTION="${1:-}"
shift || true

DB="/etc/pihole/gravity.db"
ID_FILE="/var/lib/gandalf/pihole_blockall_domainlist_id"
LOG="/var/log/pihole-blockall-toggle.log"

ts(){ date '+%F %T'; }
say(){ echo "$(ts) [blockall] $*" | tee -a "$LOG" >/dev/null; }

if [[ ! -f "$ID_FILE" ]]; then
  echo "Missing $ID_FILE (run pihole-policy-apply once)" >&2
  exit 2
fi
BLOCKALL_ID="$(cat "$ID_FILE")"

sql(){ sqlite3 "$DB" "$1"; }
gid(){ sql "SELECT id FROM 'group' WHERE name='$1' LIMIT 1;"; }

if [[ "$ACTION" != "on" && "$ACTION" != "off" ]]; then
  echo "Usage: $0 on|off Group1 Group2 ..." >&2
  exit 2
fi

ENABLE=1
[[ "$ACTION" == "off" ]] && ENABLE=0

for g in "$@"; do
  GID="$(gid "$g")"
  [[ -z "$GID" ]] && { say "SKIP: group not found: $g"; continue; }
  # ensure mapping exists
  sql "INSERT OR IGNORE INTO domainlist_by_group(domainlist_id,group_id) VALUES($BLOCKALL_ID,$GID);"
  # toggle enabled on domainlist (global) â€“ but we want per-group, so we keep domain enabled=1
  # and implement per-group disable by removing mapping when OFF
  if (( ENABLE == 1 )); then
    say "ON: $g"
    sql "INSERT OR IGNORE INTO domainlist_by_group(domainlist_id,group_id) VALUES($BLOCKALL_ID,$GID);"
  else
    say "OFF: $g"
    sql "DELETE FROM domainlist_by_group WHERE domainlist_id=$BLOCKALL_ID AND group_id=$GID;"
  fi
done

pihole_reload_dns >>"$LOG" 2>&1 || true
say "DONE"
